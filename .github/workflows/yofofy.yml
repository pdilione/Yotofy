name: Yotofy Sync Engine

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: write

jobs:
  sync_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: sudo apt-get install -y ffmpeg

      - name: Install Python Dependencies
        run: pip install -r backend/requirements.txt

      # 1. Restore 'public/audio' from previous gh-pages branch deployment
      #    This prevents re-downloading songs we already have.
      - name: Restore Audio Cache
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: public_cache
        continue-on-error: true

      - name: Restore Audio Files
        run: |
          mkdir -p public/audio
          if [ -d "public_cache/audio" ]; then
            echo "Restoring existing audio files..."
            cp -r public_cache/audio/* public/audio/
          else
            echo "No cache found, starting fresh."
          fi

      # 2. Run Sync Engine
      - name: Run Sync Engine
        run: python backend/sync.py
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_PLAYLIST_ID: ${{ secrets.SPOTIFY_PLAYLIST_ID }}
          # Automatically construct the GitHub Pages URL
          PUBLIC_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      # 3. Deploy to GitHub Pages (Hosts the RSS + Audio)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true # CRITICAL: Keeps MP3s safe
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
